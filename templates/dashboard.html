{% extends "base.html" %}

{% block title %}Dashboard - Podcast Summarizer{% endblock %}

{% block content %}
<div class="container">
    <div class="hero-section">
        <h2>üìä Analysis Dashboard</h2>
        <p>View all analyzed videos from your trusted channels</p>
    </div>

    <div class="dashboard-controls">
        <div class="filter-section">
            <select id="channelFilter" class="filter-select">
                <option value="">All Channels</option>
                <!-- Channels will be loaded dynamically -->
            </select>
            
            <select id="daysFilter" class="filter-select">
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
                <option value="all">All time</option>
            </select>
            
            <button 
                id="refreshBtn"
                class="btn btn-secondary" 
                onclick="refreshAnalyses()"
            >
                üîÑ Refresh
            </button>
        </div>

        <div id="dashboard-loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading analyses...</p>
        </div>
    </div>

    <div id="analyses-grid" class="analyses-grid">
        <!-- Analyses will be loaded here -->
        <div class="empty-state">
            <p>Loading analyses...</p>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div id="pagination-controls" class="pagination-controls" style="display: none;">
        <div class="pagination-info">
            <span id="pagination-info-text">Showing 1-10 of 0 results</span>
        </div>
        <div class="pagination-buttons">
            <button id="first-page-btn" class="btn btn-pagination" disabled>‚èÆÔ∏è First</button>
            <button id="prev-page-btn" class="btn btn-pagination" disabled>‚¨ÖÔ∏è Previous</button>
            <span id="page-info" class="page-info">Page 1 of 1</span>
            <button id="next-page-btn" class="btn btn-pagination" disabled>Next ‚û°Ô∏è</button>
            <button id="last-page-btn" class="btn btn-pagination" disabled>Last ‚è≠Ô∏è</button>
        </div>
    </div>
</div>

<script>
// Global pagination state
let currentPage = 1;
let totalPages = 1;
let pageSize = 10;
let totalCount = 0;

// Load analyses on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check URL for page parameter
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get('page');
    if (pageParam) {
        currentPage = parseInt(pageParam) || 1;
    }
    
    loadChannels();
    loadAnalyses(currentPage);
    setupPaginationEventListeners();
});

async function loadChannels() {
    try {
        const response = await fetch('/api/channels');
        const data = await response.json();
        
        const channelFilter = document.getElementById('channelFilter');
        
        // Clear existing options except "All Channels"
        channelFilter.innerHTML = '<option value="">All Channels</option>';
        
        // Add channels from API
        data.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.channel_id;
            option.textContent = channel.name;
            channelFilter.appendChild(option);
        });
        
        console.log(`Loaded ${data.channels.length} channels`);
    } catch (error) {
        console.error('Error loading channels:', error);
    }
}

async function loadAnalyses(page = 1) {
    const channelFilter = document.getElementById('channelFilter').value;
    const daysFilter = document.getElementById('daysFilter').value;
    const loading = document.getElementById('dashboard-loading');
    const grid = document.getElementById('analyses-grid');
    
    loading.style.display = 'block';
    
    try {
        let url = '/api/analyses';
        const params = new URLSearchParams();
        
        // Add pagination parameters
        params.append('page', page);
        params.append('page_size', pageSize);
        
        // Handle filters
        if (daysFilter !== 'all') {
            url = `/api/analyses/recent`;
            params.append('days', daysFilter);
        }
        if (channelFilter) {
            params.append('channel_id', channelFilter);
        }
        
        url += `?${params.toString()}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        // Update pagination state
        currentPage = data.page || 1;
        totalPages = data.total_pages || 1;
        totalCount = data.total_count || 0;
        
        console.log('Received data:', data);
        console.log('Analyses count:', data.analyses ? data.analyses.length : 0);
        
        renderAnalysesGrid(data.analyses);
        updatePaginationControls(data);
        updateURL(currentPage);
        
    } catch (error) {
        console.error('Error loading analyses:', error);
        grid.innerHTML = '<div class="error-state">Failed to load analyses</div>';
    } finally {
        loading.style.display = 'none';
    }
}

function renderAnalysesGrid(analyses) {
    console.log('renderAnalysesGrid called with:', analyses);
    const grid = document.getElementById('analyses-grid');
    
    if (!analyses || analyses.length === 0) {
        grid.innerHTML = '<div class="empty-state"><p>No analyses found</p></div>';
        return;
    }
    
    const analysesHTML = analyses.map(analysis => {
        const hasRecommendation = analysis.analysis.includes('**Recommendation:**') && 
                                 !analysis.analysis.includes('**Recommendation:Other**');
        const recommendationType = getRecommendationType(analysis.analysis);
        
        return `
            <div class="analysis-card ${hasRecommendation ? 'has-recommendation' : ''}">
                <div class="analysis-header">
                    <h3 class="analysis-title">${analysis.title}</h3>
                    <div class="analysis-meta">
                        <span class="channel-badge">üì∫ ${analysis.channel_name || 'Unknown'}</span>
                        <span class="date-badge">üìÖ ${formatDate(analysis.published_at)}</span>
                        <span class="duration-badge">‚è±Ô∏è ${formatDuration(analysis.video_duration)}</span>
                    </div>
                    ${hasRecommendation ? `<div class="recommendation-badge">${recommendationType}</div>` : ''}
                </div>
                
                <div class="analysis-summary" id="summary-${analysis.video_id}">
                    ${getAnalysisSummary(analysis.analysis)}
                </div>
                
                <div class="analysis-full" id="full-${analysis.video_id}" style="display: none;">
                    ${formatAnalysisText(analysis.analysis, analysis.video_url)}
                </div>
                
                <div class="analysis-actions">
                    <button 
                        class="btn btn-sm"
                        onclick="toggleAnalysis('${analysis.video_id}')"
                    >
                        <span id="toggle-text-${analysis.video_id}">üìñ Show Full</span>
                    </button>
                    <a 
                        href="${analysis.video_url}" 
                        target="_blank" 
                        class="btn btn-sm"
                    >
                        ‚ñ∂Ô∏è Watch
                    </a>
                    <button 
                        class="btn btn-sm"
                        onclick="copyAnalysis('${analysis.video_id}')"
                    >
                        üìã Copy
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = analysesHTML;
}

function getRecommendationType(analysis) {
    if (analysis.includes('**Stock**')) return 'üìà Stock';
    if (analysis.includes('**Sector**')) return 'üè≠ Sector';
    if (analysis.includes('**Portfolio strategy**') || analysis.includes('**Concentrated Portfolios**')) return 'üíº Portfolio';
    if (analysis.includes('**Own Gold**')) return 'üèÜ Gold';
    return 'üí° Insight';
}

function getAnalysisSummary(text) {
    // Extract just the summary section if available
    const summaryMatch = text.match(/\*\*Summary:\*\*(.*?)(?=\*\*|$)/s);
    if (summaryMatch) {
        const summary = summaryMatch[1].trim().substring(0, 300);
        return formatAnalysisText(summary + '...');
    }
    return formatAnalysisText(text.substring(0, 300) + '...');
}

function formatAnalysisText(text, videoUrl) {
    // Parse analysis into sections
    const sections = parseAnalysisSections(text);
    
    if (sections.length > 0) {
        return formatSectionedAnalysis(sections, videoUrl);
    }
    
    // Fallback to original formatting if no sections found
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>')
        // Enhanced timestamp patterns: (0:56), (0:56-1:14), (1:23:45), etc.
        .replace(/\((\d{1,2}:\d{2}(?::\d{2})?(?:-\d{1,2}:\d{2}(?::\d{2})?)?)\)/g, (match, timeRange) => {
            // Extract start time from range like \"0:56-1:14\" -> \"0:56\"
            const startTime = timeRange.split('-')[0];
            const timestampUrl = createTimestampUrl(videoUrl, startTime);
            return `<a href=\"${timestampUrl}\" target=\"_blank\" class=\"timestamp-link\">${match}</a>`;
        });
}

function parseAnalysisSections(text) {
    const sections = [];
    
    // Enhanced regex to capture more section patterns
    const sectionPatterns = [
        /\*\*(Summary|Recommendation|Rationale|Key Points?|Analysis Points?|Market Impact Analysis|Key Topics?|Main Points?|Key Takeaways?):\*\*(.*?)(?=\n\*\*|$)/gs,
        /\n\n(Summary|Recommendation|Rationale|Key Points?|Analysis Points?|Market Impact Analysis|Key Topics?|Main Points?|Key Takeaways?):\n(.*?)(?=\n\n[A-Z][a-z]+:|$)/gs,
        /(Summary|Recommendation|Rationale|Key Points?|Analysis Points?|Market Impact Analysis|Key Topics?|Main Points?|Key Takeaways?):\s*(.*?)(?=\n[A-Z][a-z]+:|$)/gs
    ];
    
    for (const regex of sectionPatterns) {
        let match;
        while ((match = regex.exec(text)) !== null) {
            const [fullMatch, title, content] = match;
            const cleanTitle = title.trim();
            const cleanContent = content.trim();
            
            // Avoid duplicates
            if (!sections.find(s => s.title === cleanTitle) && cleanContent.length > 0) {
                sections.push({
                    title: cleanTitle,
                    content: cleanContent,
                    isHighlighted: ['Recommendation', 'Rationale'].includes(cleanTitle)
                });
            }
        }
        regex.lastIndex = 0; // Reset regex
    }
    
    // If no sections found, try to split by double line breaks
    if (sections.length === 0) {
        const paragraphs = text.split('\n\n').filter(p => p.trim().length > 0);
        paragraphs.forEach((paragraph, index) => {
            if (paragraph.trim().length > 0) {
                sections.push({
                    title: `Section ${index + 1}`,
                    content: paragraph.trim(),
                    isHighlighted: false
                });
            }
        });
    }
    
    return sections;
}

function formatSectionedAnalysis(sections, videoUrl) {
    return sections.map(section => {
        const sectionClass = section.isHighlighted ? 'analysis-section highlighted' : 'analysis-section';
        let formattedContent = section.content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>')
            // Enhanced timestamp patterns: (0:56), (0:56-1:14), (1:23:45), etc.
            .replace(/\((\d{1,2}:\d{2}(?::\d{2})?(?:-\d{1,2}:\d{2}(?::\d{2})?)?)\)/g, (match, timeRange) => {
                // Extract start time from range like "0:56-1:14" -> "0:56"
                const startTime = timeRange.split('-')[0];
                const timestampUrl = createTimestampUrl(videoUrl, startTime);
                return `<a href="${timestampUrl}" target="_blank" class="timestamp-link">${match}</a>`;
            });
        
        return `
            <div class="${sectionClass}">
                <h4 class="section-title">${section.title}:</h4>
                <div class="section-content">${formattedContent}</div>
            </div>
        `;
    }).join('');
}

function createTimestampUrl(videoUrl, timeStr) {
    // Handle different time formats: 0:56, 1:23:45, etc.
    const timeParts = timeStr.split(':').map(Number);
    let totalSeconds = 0;
    
    if (timeParts.length === 2) {
        // MM:SS format
        totalSeconds = timeParts[0] * 60 + timeParts[1];
    } else if (timeParts.length === 3) {
        // HH:MM:SS format
        totalSeconds = timeParts[0] * 3600 + timeParts[1] * 60 + timeParts[2];
    } else {
        // Invalid format, return original URL
        return videoUrl;
    }
    
    // Extract video ID from URL
    const videoId = extractVideoId(videoUrl);
    if (!videoId) return videoUrl;
    
    return `https://www.youtube.com/watch?v=${videoId}&t=${totalSeconds}s`;
}

function extractVideoId(url) {
    const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
    return match ? match[1] : null;
}

function toggleAnalysis(videoId) {
    const summary = document.getElementById(`summary-${videoId}`);
    const full = document.getElementById(`full-${videoId}`);
    const toggleText = document.getElementById(`toggle-text-${videoId}`);
    
    if (full.style.display === 'none') {
        summary.style.display = 'none';
        full.style.display = 'block';
        toggleText.textContent = 'üìï Show Less';
    } else {
        summary.style.display = 'block';
        full.style.display = 'none';
        toggleText.textContent = 'üìñ Show Full';
    }
}

function copyAnalysis(videoId) {
    const full = document.querySelector(`#full-${videoId}`);
    const summary = document.querySelector(`#summary-${videoId}`);
    const content = full.style.display !== 'none' ? full : summary;
    
    const text = content.innerText || content.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
        alert('Analysis copied to clipboard!');
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
    });
}

function formatDate(dateStr) {
    if (!dateStr) return 'Unknown';
    return new Date(dateStr).toLocaleDateString();
}

function formatDuration(seconds) {
    if (!seconds) return 'Unknown';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Pagination functions
function setupPaginationEventListeners() {
    document.getElementById('first-page-btn').addEventListener('click', () => goToPage(1));
    document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPage - 1));
    document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPage + 1));
    document.getElementById('last-page-btn').addEventListener('click', () => goToPage(totalPages));
}

function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        loadAnalyses(page);
    }
}

function updatePaginationControls(data) {
    const paginationControls = document.getElementById('pagination-controls');
    const paginationInfo = document.getElementById('pagination-info-text');
    const pageInfo = document.getElementById('page-info');
    
    const firstBtn = document.getElementById('first-page-btn');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const lastBtn = document.getElementById('last-page-btn');
    
    // Show pagination controls only if there are results
    if (data.total_count > 0) {
        paginationControls.style.display = 'flex';
        
        // Update info text
        const start = (data.page - 1) * data.page_size + 1;
        const end = Math.min(data.page * data.page_size, data.total_count);
        paginationInfo.textContent = `Showing ${start}-${end} of ${data.total_count} results`;
        
        // Update page info
        pageInfo.textContent = `Page ${data.page} of ${data.total_pages}`;
        
        // Update button states
        firstBtn.disabled = !data.has_prev;
        prevBtn.disabled = !data.has_prev;
        nextBtn.disabled = !data.has_next;
        lastBtn.disabled = !data.has_next;
    } else {
        paginationControls.style.display = 'none';
    }
}

function updateURL(page) {
    const url = new URL(window.location);
    if (page > 1) {
        url.searchParams.set('page', page);
    } else {
        url.searchParams.delete('page');
    }
    window.history.replaceState({}, '', url);
}

// Refresh function that resets to page 1 when called from filter changes
function refreshAnalyses() {
    currentPage = 1;
    loadAnalyses(1);
}
</script>

<style>
.dashboard-controls {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filter-section {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    min-width: 150px;
}

.analyses-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

.analysis-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s;
}

.analysis-card:hover {
    transform: translateY(-2px);
}

.analysis-card.has-recommendation {
    border-left: 4px solid #667eea;
}

.analysis-header {
    margin-bottom: 1rem;
    position: relative;
}

.analysis-title {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: #333;
}

.analysis-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.channel-badge, .date-badge, .duration-badge {
    font-size: 0.9rem;
    color: #666;
}

.recommendation-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.analysis-summary, .analysis-full {
    line-height: 1.6;
    color: #444;
    margin-bottom: 1rem;
}

.analysis-actions {
    display: flex;
    gap: 0.5rem;
}

.timestamp {
    background: #f0f0f0;
    padding: 0.1rem 0.3rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9rem;
}

.timestamp-link {
    background: #007bff;
    color: white;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    text-decoration: none;
    font-family: monospace;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.timestamp-link:hover {
    background: #0056b3;
    color: white;
    text-decoration: none;
}

/* Analysis Section Styling */
.analysis-section {
    margin-bottom: 2rem;
    padding: 1.25rem;
    border-radius: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
}

.analysis-section.highlighted {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-left: 4px solid #ffc107;
}

.section-title {
    color: #333;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

.analysis-section.highlighted .section-title {
    color: #856404;
}

.section-content {
    line-height: 1.6;
    color: #555;
}

.analysis-section.highlighted .section-content {
    color: #664d03;
}

/* Pagination Controls */
.pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.pagination-info {
    font-size: 0.95rem;
    color: #666;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-pagination {
    padding: 0.5rem 1rem;
    border: 2px solid #e1e5e9;
    background: white;
    color: #333;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.btn-pagination:not(:disabled):hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

.btn-pagination:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info {
    padding: 0 1rem;
    font-weight: 500;
    color: #333;
}

@media (min-width: 768px) {
    .analyses-grid {
        grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
    }
}
</style>
{% endblock %}